# Hajimi Ref 技术文档

## 1. 项目概述
Hajimi Ref 是一个基于 Python 的轻量级参考图查看器，旨在提供类似 PureRef 的核心体验。项目坚持“少依赖、单文件”的原则，仅使用 `tkinter` 作为 GUI 框架，`Pillow` 处理图像，最终通过 `PyInstaller` 打包为单个可执行文件。

## 2. 技术架构

### 2.1 核心依赖
*   **Python 3.x**: 开发语言。
*   **Tkinter**: Python 标准库自带的 GUI 框架，保证了极小的体积和跨平台能力。
*   **Pillow (PIL)**: 唯一的第三方依赖，用于强大的图像读取、处理和重采样支持。
*   **PyInstaller**: 用于将 Python 脚本打包成独立的 EXE 文件。

### 2.2 类结构设计

#### `ImageItem` 类
负责单个图像对象的管理。
*   **数据存储**: 保留原始图像二进制数据 (`image_data`)，而非仅仅持有 PIL Image 对象，确保多次缩放后画质不损失。
*   **渲染逻辑**: 
    *   `reload_image()`: 核心渲染方法。根据当前的缩放比例 (`scale`) 和位置 (`x`, `y`) 计算图像状态。
    *   **视口裁剪 (Viewport Clipping)**: 为了解决大图缩放卡顿问题，该类实现了视口裁剪算法。只裁剪并渲染当前视口 (`viewport`) 内可见的图像区域，而非渲染整张放大后的图片。
*   **序列化**: `to_dict()` 和 `from_dict()` 方法支持将图像数据（Base64编码）和状态序列化为 JSON 格式，用于保存和读取。

#### `SimpleRefApp` 类
主应用程序类，管理窗口生命周期和全局交互。
*   **画布管理**: 使用 `tk.Canvas` 实现无限画布效果。
*   **交互事件**:
    *   **平移 (Pan)**: 监听中键或空格+左键，使用 `canvas.scan_dragto` 实现画布平移。
    *   **缩放 (Zoom)**: 监听滚轮事件。由于 Tkinter Canvas 没有内置的视图缩放，我们通过遍历所有 `ImageItem` 并更新其坐标和缩放比例来模拟视图缩放。
*   **性能优化调度**:
    *   **动态重采样 (Dynamic Resampling)**: 
        *   交互中（如滚动、拖拽）：使用 `Image.Resampling.NEAREST` (最近邻插值)，速度极快。
        *   交互停止（Debounce 200ms）：自动触发 `perform_hq_render`，切换到 `Image.Resampling.LANCZOS` (兰索斯插值) 或 `BILINEAR`，提供高质量画质。

## 3. 关键技术难点与解决方案

### 3.1 大图缩放卡顿
*   **问题**: 当图片放大倍数很大（如 500%）时，生成一张巨大的位图并传给 Tkinter 会导致内存暴涨和渲染极度卡顿。
*   **解决**: 实现 **Viewport Clipping**。
    1.  计算图片在当前缩放比例下的屏幕包围盒。
    2.  计算该包围盒与当前屏幕视口 (`viewport`) 的交集。
    3.  利用 `PIL.Image.crop()` 只裁剪出交集部分的原始像素。
    4.  只将这部分裁剪后的区域 resize 到屏幕显示大小并渲染。
    *   **结果**: 渲染开销与图片放大倍数无关，仅与屏幕分辨率有关，极大提升了性能。

### 3.2 交互流畅度与画质的平衡
*   **问题**: 高质量插值算法（如 Lanczos）计算耗时，无法在 60fps 的交互中实时运行。
*   **解决**: 引入“动静分离”策略。
    *   用户操作时（滚动、拖拽），强制使用低质量但极快的算法。
    *   用户停止操作 200ms 后，后台静默触发高质量重绘。

### 3.3 剪贴板支持
*   **问题**: Tkinter 原生剪贴板支持有限。
*   **解决**: 
    *   使用 `ImageGrab.grabclipboard()` 获取图像数据。
    *   兜底逻辑：尝试读取剪贴板文本，解析为文件路径列表，支持从资源管理器直接复制文件粘贴。

## 4. 数据存储
*   **格式**: 自定义 `.sref` 格式（本质为 JSON）。
*   **内容**: 包含版本号、所有图片的 Base64 编码数据、位置坐标、缩放比例。
*   **优势**: 单文件包含所有资源，便于分享和迁移。

## 5. 构建与发布
使用 PyInstaller 进行单文件打包：
```bash
pyinstaller --noconsole --onefile --name "Hajimi Ref" main.py
```
